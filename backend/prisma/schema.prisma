generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  username       String         @unique
  password       String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  teams          TeamMember[]
  createdGames   Game[]
  gameSessions   GameSession[]
  activities     Activity[]
  
  @@index([email])
  @@index([username])
}

model Team {
  id             String         @id @default(cuid())
  name           String
  slug           String         @unique
  inviteCode     String         @unique @default(cuid())
  description    String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  members        TeamMember[]
  defenders      Defender[]
  games          Game[]
  defensiveLines DefensiveLine[]
  
  @@index([slug])
  @@index([inviteCode])
}

model TeamMember {
  id             String         @id @default(cuid())
  userId         String
  teamId         String
  role           TeamRole       @default(MEMBER)
  joinedAt       DateTime       @default(now())
  
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  team           Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum DefenderPosition {
  HANDLER
  HYBRID
  CUTTER
}

model Defender {
  id             String         @id @default(cuid())
  name           String
  teamId         String
  position       DefenderPosition @default(HYBRID)
  notes          String?
  active         Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  team           Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  matchups       Matchup[]
  statistics     DefenderStats[]
  availableFor   AvailableDefender[]
  currentPointFor CurrentPointDefender[]
  defensiveLines DefensiveLineDefender[]
  selectedGames  SelectedDefender[]
  
  @@index([teamId])
  @@index([name])
}

model Game {
  id             String         @id @default(cuid())
  name           String
  slug           String         @unique
  shareCode      String         @unique @default(cuid())
  teamId         String
  createdById    String
  opponent       String?
  location       String?
  gameDate       DateTime?
  isPublic       Boolean        @default(false)
  status         GameStatus     @default(SETUP)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  team           Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy      User           @relation(fields: [createdById], references: [id], onDelete: Cascade)
  offensivePlayers OffensivePlayer[]
  points         Point[]
  sessions       GameSession[]
  activities     Activity[]
  selectedDefenders SelectedDefender[]
  
  @@index([slug])
  @@index([shareCode])
  @@index([teamId])
  @@index([createdById])
}

enum GameStatus {
  SETUP
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

model OffensivePlayer {
  id             String         @id @default(cuid())
  gameId         String
  name           String
  position       OffensivePosition @default(CUTTER)
  jerseyNumber   String?
  order          Int            @default(0)
  isBench        Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  matchups       Matchup[]
  availableDefenders AvailableDefender[]
  currentPointDefender CurrentPointDefender?
  
  @@index([gameId])
}

enum OffensivePosition {
  HANDLER
  CENTER_HANDLER
  RESET_HANDLER
  CUTTER
  FRONT_OF_STACK
  INITIATING_CUTTER
  FILL_CUTTER
  DEEP_CUTTER
}

model Point {
  id             String         @id @default(cuid())
  gameId         String
  pointNumber    Int
  gotBreak       Boolean
  notes          String?
  windSpeed      Float?
  windDirection  String?
  selectedDefenderIds String[]  @default([])
  startedAt      DateTime       @default(now())
  completedAt    DateTime?
  
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  matchups       Matchup[]
  
  @@unique([gameId, pointNumber])
  @@index([gameId])
}

model Matchup {
  id                String          @id @default(cuid())
  pointId           String
  offensivePlayerId String
  defenderId        String?
  isActive          Boolean         @default(true)
  result            MatchupResult?
  notes             String?
  createdAt         DateTime        @default(now())
  
  point             Point           @relation(fields: [pointId], references: [id], onDelete: Cascade)
  offensivePlayer   OffensivePlayer @relation(fields: [offensivePlayerId], references: [id], onDelete: Cascade)
  defender          Defender?       @relation(fields: [defenderId], references: [id])
  
  @@index([pointId])
  @@index([offensivePlayerId])
  @@index([defenderId])
}

enum MatchupResult {
  SHUTDOWN
  CONTAINED
  SCORED_ON
  NEUTRAL
}

model DefenderStats {
  id             String         @id @default(cuid())
  defenderId     String
  gameId         String
  pointsPlayed   Int            @default(0)
  breaks         Int            @default(0)
  noBreaks       Int            @default(0)
  blocks         Int            @default(0)
  turns          Int            @default(0)
  
  defender       Defender       @relation(fields: [defenderId], references: [id], onDelete: Cascade)
  
  @@unique([defenderId, gameId])
  @@index([defenderId])
  @@index([gameId])
}

model GameSession {
  id             String         @id @default(cuid())
  gameId         String
  userId         String
  socketId       String?
  isActive       Boolean        @default(true)
  lastPing       DateTime       @default(now())
  joinedAt       DateTime       @default(now())
  leftAt         DateTime?
  
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
  @@index([socketId])
}

model Activity {
  id             String         @id @default(cuid())
  gameId         String
  userId         String
  type           ActivityType
  description    String
  metadata       Json?
  createdAt      DateTime       @default(now())
  
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
  @@index([userId])
  @@index([createdAt])
}

enum ActivityType {
  GAME_CREATED
  GAME_STARTED
  GAME_COMPLETED
  POINT_ADDED
  POINT_EDITED
  POINT_DELETED
  PLAYER_ADDED
  PLAYER_REMOVED
  MATCHUP_CHANGED
  USER_JOINED
  USER_LEFT
}

model AvailableDefender {
  id                String          @id @default(cuid())
  offensivePlayerId String
  defenderId        String
  createdAt         DateTime        @default(now())
  
  offensivePlayer   OffensivePlayer @relation(fields: [offensivePlayerId], references: [id], onDelete: Cascade)
  defender          Defender        @relation(fields: [defenderId], references: [id], onDelete: Cascade)
  
  @@unique([offensivePlayerId, defenderId])
  @@index([offensivePlayerId])
  @@index([defenderId])
}

model CurrentPointDefender {
  id                String          @id @default(cuid())
  offensivePlayerId String          @unique
  defenderId        String
  createdAt         DateTime        @default(now())
  
  offensivePlayer   OffensivePlayer @relation(fields: [offensivePlayerId], references: [id], onDelete: Cascade)
  defender          Defender        @relation(fields: [defenderId], references: [id], onDelete: Cascade)
  
  @@index([defenderId])
}

model DefensiveLine {
  id             String         @id @default(cuid())
  teamId         String
  name           String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  team           Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  defenders      DefensiveLineDefender[]
  
  @@index([teamId])
}

model DefensiveLineDefender {
  id             String         @id @default(cuid())
  lineId         String
  defenderId     String
  order          Int            @default(0)
  
  line           DefensiveLine  @relation(fields: [lineId], references: [id], onDelete: Cascade)
  defender       Defender       @relation(fields: [defenderId], references: [id], onDelete: Cascade)
  
  @@unique([lineId, defenderId])
  @@index([lineId])
  @@index([defenderId])
}

model SelectedDefender {
  id             String         @id @default(cuid())
  gameId         String
  defenderId     String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  game           Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  defender       Defender       @relation(fields: [defenderId], references: [id], onDelete: Cascade)
  
  @@unique([gameId, defenderId])
  @@index([gameId])
  @@index([defenderId])
}